# PTL.PRS

This is the official codebase for PTL-PRS: an R package for transfer learning of polygenic risk scores with pseudovalidation.
[![medRxiv](https://img.shields.io/badge/medRxiv-10.1101%2F2025.06.19.25329937v1-blue)](https://www.medrxiv.org/content/10.1101/2025.06.19.25329937v1)

This R package helps users to construct multi-ethnic polygenic risk score (PRS) using transfer learning when the individual level data is not available. It can help predict PRS of small group using summary statistics from larger group resources.

This package contains main functions: `PTL_PRS_train` for train, `PTL_PRS_run` for train with multiple seeds, `PTL_PRS_test_pseudo` and `PTL_PRS_test` for test, and `pseudo_split` for pseudo splitting.

## Core functions
- `pseudo_split`:
   Create pseudo train/val(/test) splits from target summary statistics, using the target reference panel for LD-aware sampling.
- `PTL_PRS_train`:
   generates/reads pseudo splits, runs block-wise gradient descent, tunes LR on pseudo-validation, and writes outputs with outfile prefix.
- `PTL_PRS_run`:
   Repeat the full training pipeline over multiple seeds, namespace outputs per seed, and return a summary. Use this when you want more robust pseudo-R² estimates: the pseudosplit–based metric has sampling variability, and repeating across seeds stabilizes results.
- `PTL_PRS_test_pseudo` or `PTL_PRS_test`:
   Evaluate pseudo-R² or true-R² on held-out pseudo-test summaries, reporting baseline vs. adapted model performance.

## Installation
`PTL.PRS` requires the software 'plink' as well as the following R packages:  `data.table`, `Rcpp`, `RcppParallel` and `parallel`. Install them by: 

```r
install.packages(c("data.table", "RcppParallel", "parallel", "Rcpp"), dependencies=TRUE)
```

If you have `devtools`, you can type: 
```r
install_github("bokeumcho/PTL.PRS")
```
for the latest development version. Or you can clone the latest development version here and install yourself using `devtools`. 

### Download LD Reference Panels

LD reference panels for multiple ancestries are available via our Zenodo upload.  
These panels are derived from **1000 Genomes Project Phase 3** samples, lifted over to **GRCh38** coordinates, and packaged in PLINK binary format.

Access the LD reference panels on [Zenodo](https://zenodo.org/records/16785891?token=eyJhbGciOiJIUzUxMiJ9.eyJpZCI6IjMxODJhMWY3LThmNGQtNGIxNC05NGJiLThlZGUxZjUyZjFjNiIsImRhdGEiOnt9LCJyYW5kb20iOiJmNDZkMTEyNDUxZWUzOTk5ZDBkNzA3ZjczMTgwN2YzMyJ9.HV-r3QLy3sGZsHgmVvUhYCiIp-b1Nz-c6Sz2kM64GYlwQRhT9RdsxGmKCvOMHM6jnFub6iTil7AwaF4k63lmEQ)
 [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.16786034.svg)](https://doi.org/10.5281/zenodo.16786034)


Each ancestry is provided as a compressed archive (`.tar.gz`) containing:
- `*.bed` — genotype data in PLINK binary format  
- `*.bim` — SNP information (chromosome, position, alleles)  
- `*.fam` — sample information  

## Inputs of PTL_PRS
### Input Arguments for PTL_PRS_train

1. `ref_file`: 
   The prefix of the PLINK file for the reference panel data in the target population. This file is used to estimate the LD matrix during training and validation steps.

2. `ref_file_ps`: 
   The prefix of the PLINK file for the reference panel data in the target population used to generate pseudo-summary statistics. This can be the same file as `ref_file`, but the model is more reliable when using a different file.

3. `sum_stats_file`: 
   The file path for the effect size data. This file can be generated by existing PRS methods, such as Lassosum or PRS-CS. It contains the following columns: `SNP`, `CHR`, `A1`, `Beta`, where:
   - `SNP`: SNP ID (same format as rsid in PLINK bim files)
   - `CHR`: Chromosome number
   - `A1`: Alternative (effect) allele
   - `Beta`: Effect size

4. `LDblocks`: 
   Defines LD regions using the definitions by Berisa and Pickrell (2015) for the hg19 genome in the target population. Currently supported options are:
   - `EUR.hg19` (European)
   - `AFR.hg19` (African)
   - `ASN.hg19` (Asian)

5. `outfile`: 
   The prefix for the output file location. This will be used to store final output files.

6. `ps`: 
    Pseudo-summary generation flag. If TRUE, pseudo-split target summary statistics into train and validation sets.

    - **When `ps` == TRUE**:

      6-1. `target_sumstats_file`: The file path for the summary statistics in the target population. This file must contain the following columns: `SNP`, `A1`, `beta`, `p`, and `N`, where:
        - `beta`: Effect size from summary statistics or its signs
        - `p`: p-value
        - `N`: Sample size used for summary statistics calculation

      Alternatively, the file can include a `cor` column instead of `beta` and `p`, representing the correlation between genotype and phenotype.

      **Note:** This file is used to generate pseudo-summary statistics.
      
      6-2. `subprop`: Proportion of training samples in full summary statistics.

      6-3. `pseudo_test` (optional): Logical; if TRUE, pseudo-split target summary statistics into train, validation, and test sets as well.

      6-4. `random_seed` (optional): Random seed number for pseudo-splitting target summary statistics.

    - **When `ps` == FALSE**:
    
      6-5. `target_sumstats_train_file`: File path for target summary statistics for training samples. 
      
      6-6. `target_sumstats_val_file`: File path for target summary statistics for validation samples. 

7. `lr_list` (optional): 
   A grid of candidate learning-rate numerators for block-wise optimization. Each value is scaled by the number of SNPs used in training. If not specified, a default value is `c(1, 10, 100, 1000)` (which becomes `min(1, 10, 100, 1000 / n(SNPs), 1)` at run time).

8. `iter` (optional): 
   Maximum number of iterations for early stopping during training. Default value is 100 if not specified.

9. `num_cores` (optional): 
    Number of cores to be used for parallel computation during training. Parallelization speeds up coefficient updates and training-data preparation across blocks. Defaults to 1 (no parallelization).

10. `patience` (optional): 
    Number of times to tolerate a decrease in validation pseudo-R without early stopping. Defaults to 3.

11. `trace` (optional): 
    Logical; if TRUE, print the stopped iteration for each LD block. Defaults to FALSE.

### Input Arguments for PTL_PRS_run
1. `cfg`: 
   A configuration list created by **PTL_PRS_config(...)**. It carries all training inputs used by **PTL_PRS_train**.
   - Required keys in `cfg`: `ref_file`, `ref_file_ps`, `sum_stats_file`, `target_sumstats_file`, `subprop`, `outfile`.
   - Everything else mirrors the meanings described for **PTL_PRS_train** (above).

2. `num_repeat_ps`:
   Number of independent seeds to run when doing pseudo-test evaluation.
   - Effective only if `cfg$ps = TRUE`.
   - When > 1, the entire **PTL_PRS_train** pipeline is repeated per seed.
   - Each run writes to a unique prefix: `paste0(cfg$outfile, "_seed", <seed>)`.
   - **Recommendation**: start with the default value 5. If the standard error of relative accuracy across seeds (sd / sqrt(num_repeat_ps)) exceeds 2, increase `num_repeat_ps`.

3. `random_seeds_repeat` (optional):
   The exact set of unique, positive seeds to use across repeats. Length must equal num_repeat_ps.
   - If not provided, seeds are sampled randomly.
   - No recycling: a length mismatch raises an error.
   - Each seed is passed as `random_seed` to **PTL_PRS_train** and used to suffix outfile (`..._seed<seed>`), ensuring file outputs don’t collide.

### Input Arguments for PTL_PRS_test
1. `ped_test_file`:
   The file path to the ped file for test samples, which contains information such as FID, IID, phenotype (Y), sample indices from the .fam file of `plink_file` (fam_idx), and covariate columns if needed. Note that the file only requires samples for test.

2. `by_chr` (optional):
   Logical; if TRUE, read and compute matrix by chromosomes to avoid memory burden. Defaults to FALSE.

3. `plink_file`:
   The prefix of the PLINK file containing the test data. There is no need to create a separate PLINK file for test samples, as the package automatically reads only the samples specified in `ped_test_file`. 

4. `plink_etc`:
   Extra string in the prefix of the PLINK file between chromosome number and file extension. No need to specify if not necessary or `by_chr`=False. Defaults to ''.

   **Note:** If `by_chr` is set to TRUE, ensure that your PLINK files are split by chromosomes and exclude the chromosome number from the prefix. For example, if the full prefix for chromosome 1 is ukb_imp_chr1_v1, `plink_file` = 'ukb_imp_chr', `plink_etc` = '_v1'. The package will append the appropriate chromosome numbers during processing automatically.

5. `Covar_name`: A vector of names of covariates we need to adjust in the model, such as c("Sex","Age"). Note that all names must corrspond to the columns in the ped file.

6. `Y_name`: The name of Y in the model, such as "LDL". Note that the Y name must corrspond to a column in the ped file.

7. `Ytype`: The type of Y should be either "C"(continuous) or "B"(binary).

`outfile` is the same as **PTL_PRS_train**

## Outputs of PTL_PRS
1. `best.beta`: 
   A list of the baseline and best beta coefficients found during validation. It contains the following columns: `SNP`, `CHR`, `A1`, `base.beta`, `best.beta`. 

2. `best.param`: 
   The best learning rate determined by the validation.

3. `R2.list`: 
   A list of R-squared values computed during the validation step.

4. `beta.list`: 
   An intermediate output file containing the beta coefficients updated for all learning rates.

5. `target.train.summaries`:
   Pseudo summary statistics generated for train samples via `pseudo_split` function. (Only when `ps` is TRUE)

6. `target.val.summaries`:
   Pseudo summary statistics generated for validation samples via `pseudo_split` function. (Only when `ps` is TRUE)

7. `target.test.summaries`:
   Pseudo summary statistics generated for test samples via `pseudo_split` function. (Only when `ps` and `pseudo_test` are both TRUE)

## Toy Example 
You can download the example data and R scripts on [Zenodo](https://zenodo.org/records/17150787?token=eyJhbGciOiJIUzUxMiJ9.eyJpZCI6ImE1NGEwOWUwLTRiZjItNDc2MS05ZmFkLTY0ZjNlNjgwN2Q1YSIsImRhdGEiOnt9LCJyYW5kb20iOiJmMDc3OTk5ZDQzZjAzZGMyNGVmM2E5N2I1ZTY4MDQ4ZSJ9.ISYJFkIk2RPMsCzPFRMSAk5eE9MJSg5LW__BDDCFM9LPSKWcswGFvOX9HVtBCB1yIWdShJm0p8EtqFpuK1iGHw) [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.17150787.svg)](https://doi.org/10.5281/zenodo.17150787)

## Support
If there are any further questions or problems with running or installing `PTL.PRS`, please do email me at <bokeum1810@snu.ac.kr>. 
